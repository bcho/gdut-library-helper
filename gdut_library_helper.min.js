// ==UserScript==
// @name       GDUT library helper
// @namespace  http://library.gdut.edu.cn
// @version    0.2.2
// @description  Show the available books amount in GDUT library.
// @match      http://book.douban.com/*
// @match      http://222.200.98.171:81/*
// @match      http://www.baidu.com/*
// @copyright  2012-2013, Link, hbc
// @require http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.8.3.min.js
// @require http://isbn.jpn.org/js/isbn.js
// @require http://isbn.jpn.org/js/isbn-groups.js
// ==/UserScript==
// @grant GM_xmlhttpRequest
var helper={pages:{subject:{},subject_search:{},readerrecommend:{}},url:"http://222.200.98.171:81/",utils:{},tmpl:{},parser:{},kick:{}};helper.utils={},helper.utils.convertISBN=function(a,b){var c=[];return a=ISBN.parse(a),10===b?c.push(a.asIsbn10(!0)):13===b&&c.push(a.asIsbn13(!0)),c},helper.utils.gb2312=function(a){var b=$.Deferred();return GM_xmlhttpRequest({method:"GET",url:"http://www.baidu.com/s?ie=utf-8&wd="+encodeURIComponent(a),overrideMimeType:"text/xml; charset=gb2312",onload:function(a){if(!(a.status<200||a.status>300)){var c=String(a.responseText.match(/word=[^'"&]+['"&]/i)).replace(/word=|['"&]/gi,"");b.resolve(c)}},onerror:function(){}}),b.promise()},helper.utils.tmpl=function(a,b){for(var c,d=/\{\{([\w ]+)\}\}/,e=a;null!==(c=d.exec(e));)e=e.replace(c[0],b[c[1].trim()]);return e},/**
 * utils.query_factory
 *
 * 查询方法的工厂函数。
 * 因为javascript 中 `xhr` 是异步操作，而一些逻辑是有先后顺序的，
 * 所以用 jquery 里的 `deferred` 对象来实现顺序调用。
 *
 * @param meta  查询书籍的基本信息（书名、出版社、 isbn）
 * @param cmp   用作比较当前书籍和图书馆查询结果
 */
helper.utils.query_factory=function(a,b,c){return function(d){var e=new $.Deferred,f=helper.tmpl.query_url(a,d);return GM_xmlhttpRequest({method:"GET",url:f,onload:function(a){var d=helper.parser.results(a.responseText,f,b,c);d.foundc?e.resolve(d):e.reject(d)}}),e.promise()}},helper.tmpl.query_url=function(a,b){return helper.utils.tmpl(helper.url+"searchresult.aspx?dp=50&{{ type }}={{ value }}",{type:a,value:b})},helper.tmpl.library_book_url=function(a){return helper.url+"bookinfo.aspx?ctrlno="+a},helper.parser.result=function(a){var b=$(a).children();return b.length<9?null:{name:$(b[1]).text().trim(),ctrlno:$("input",b[0]).attr("value").trim(),author:$(b[2]).text().trim(),publisher:$(b[3]).text().trim(),location:$(b[5]).text().trim(),total:parseInt($(b[6]).text().trim(),10),remains:parseInt($(b[7]).text().trim(),10)}},/**
 * parser.results
 *
 * 解析查询结果的 `table`
 *
 * @return object {
 *      remains:    剩余总本数
 *      total:      总本数
 *      foundc:     是否有找到，非 0 表示找到类似条目的数目
 *      url:        查询 url
 * }
 */
helper.parser.results=function(a,b,c,d){var e={remains:0,total:0,foundc:0,location:"",url:b},f=$("#searchnotfound",a);if(0===f.length){var g,h,i,j=$("tbody tr",a);for(e.foundc=$("#ctl00_ContentPlaceHolder1_countlbl",a).html(),e.foundc=parseInt(e.foundc,10),h=0,i=j.length;i>h;h++)if(g=helper.parser.result(j[h]),null!==g&&d(g,c)){e.url=helper.tmpl.library_book_url(g.ctrlno),e.remains+=g.remains,e.total+=g.total,e.location=g.location;break}}return e},helper.parser.book_meta=function(a){var b=/出版社: (.*)/.exec($("#info",a).text());null!==b&&(b=b[1].trim());var c=/ISBN: (.*)/.exec($("#info",a).text());null!==c&&(c=c[1].trim());var d=/作者: (.*)/.exec($("#info",a).text());null!==d&&(d=d[1].trim());var e=/出版年: (.*)/.exec($("#info",a).text());return null!==e&&(e=e[1].trim()),{title:$("h1 span",a).text(),author:d,publisher:b,publish_time:e,isbn:c,isbn10:helper.utils.convertISBN(c,10),isbn13:helper.utils.convertISBN(c,13)}},helper.pages.readerrecommend=function(){var a=/douban_ref=(.*)+/.exec(document.URL);a&&GM_xmlhttpRequest({method:"GET",url:a[1],onload:function(a){var b;200===a.status&&(b=helper.parser.book_meta($(a.responseText).filter("div#wrapper")),$("#ctl00_ContentPlaceHolder1_titletb").val(b.title),$("#ctl00_ContentPlaceHolder1_isbntb").val(b.isbn),$("#ctl00_ContentPlaceHolder1_publishertb").val(b.publisher),$("#ctl00_ContentPlaceHolder1_publishdatetb").val(b.publish_time))}})},helper.pages.subject=function(){var a=function(a){var b=function(a){return helper.utils.tmpl(' | <a href="{{ url }}readerrecommend.aspx?douban_ref={{ href }}">去荐购</a>',{href:a,url:helper.url})},c=function(a){return helper.utils.tmpl('<span class="pl">GDUT:</span> {{ content }}<br />',{content:a})},d=function(a,b){return helper.utils.tmpl('&nbsp;<a target="_blank" href={{url}}>{{content}}</a>',{url:a,content:b})},e=function(a){return helper.utils.tmpl(" 在 {{ location }}",{location:a})},f=$("#info"),g="";a.foundc<=0?g=c(d(a.url,"没有找到哦")+b(document.URL)):(g=0===a.total&&0===a.remains?c(d(a.url,"找到 "+a.foundc+" 本类似的")):c(d(a.url,"还剩 "+a.remains+" 本")),a.location&&(g+=e(a.location))),f.append(g)},b=function(a,b){return a.publisher===b.publisher},c=helper.parser.book_meta($(document)),d=function(){var d=new $.Deferred,e=helper.utils.query_factory("title_f",c,b);return helper.utils.gb2312(c.title).then(function(b){e(b).then(a).fail(d.reject)}).fail(d.reject),d.promise()},e=function(){var d=new $.Deferred,e=helper.utils.query_factory("isbn_f",c,b);return e(c.isbn13).fail(function(){e(c.isbn10).then(a).fail(d.reject)}).then(a),d.promise()};e().fail(function(){d().fail(a)})},helper.pages.subject_search=function(){var a=function(){return $("#inp-query").attr("value")},b=function(a){var b,c=function(a){return helper.utils.tmpl('<div class="mb20"><div class="hd"><h2>在广工图书馆&nbsp;·&nbsp;·&nbsp;·</h2></div><div class="bd"><p class="pl">{{desc}}</p></div>',{desc:a})},d=function(a,b){return helper.utils.tmpl('&nbsp;<a target="_blank" href={{url}}>{{content}}</a>',{url:a,content:b})},e=$("#content .aside .mb20");b=a.foundc<=0?c("没有找到哦"):c(d(a.url,"找到 "+a.foundc+" 本类似的")),$(b).insertBefore(e)},c=function(){return!1},d=function(){var d=new $.Deferred,e=helper.utils.query_factory("anywords",null,c);return helper.utils.gb2312(a()).then(function(a){e(a).then(b).fail(d.reject)}).fail(d.reject),d.promise()};d().fail(b)},helper.kick=function(){var a=/[com, 81]\/([\w]+)\/*/.exec(document.URL);a=null!==a?a[1].trim():"index","subject"===a?helper.pages.subject():"subject_search"===a?helper.pages.subject_search():"readerrecommend"===a?helper.pages.readerrecommend():console.log(a)},helper.kick();